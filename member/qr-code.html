<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code - BAYK Partnership</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⛵</text></svg>">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="v4-20241220-midnight-ocean">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- QR Code Generation Library with fallbacks - QR-Code-Generator by Nayuki -->
    <script>
        // QR Code library loading with multiple fallbacks
        const qrCodeCDNs = [
            'https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js?v=4',
            'https://unpkg.com/qrcode-generator@1.4.4/qrcode.min.js?v=4',
            'https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js?v=4'
        ];
        
        let qrCodeLoaded = false;
        let currentCDN = 0;
        
        function loadQRCodeLibrary() {
            if (currentCDN >= qrCodeCDNs.length) {
                console.error('All QR Code CDNs failed to load, using local fallback');
                loadLocalQRCodeFallback();
                return;
            }
            
            const script = document.createElement('script');
            script.src = qrCodeCDNs[currentCDN];
            script.type = 'text/javascript'; // Ensure it's treated as regular JS, not module
            
            script.onload = function() {
                // Check if qrcode is actually available and working
                setTimeout(() => {
                    if (typeof qrcode !== 'undefined' && typeof qrcode === 'function') {
                        console.log('QR Code library loaded successfully from CDN', currentCDN + 1);
                        qrCodeLoaded = true;
                    } else {
                        console.log('CDN', currentCDN + 1, 'loaded but qrcode not available, trying next...');
                        currentCDN++;
                        loadQRCodeLibrary();
                    }
                }, 100);
            };
            
            script.onerror = function() {
                console.log('CDN', currentCDN + 1, 'failed, trying next...');
                currentCDN++;
                loadQRCodeLibrary();
            };
            
            document.head.appendChild(script);
        }
        
        function loadLocalQRCodeFallback() {
            // Create a minimal qrcode implementation using Google Charts API
            window.qrcode = function(typeNumber, errorCorrectionLevel) {
                return {
                    addData: function(data) {
                        this.data = data;
                        return this;
                    },
                    make: function() {
                        return this;
                    },
                    createImgTag: function(cellSize, margin) {
                        const size = cellSize || 200;
                        const encodedText = encodeURIComponent(this.data);
                        const googleChartsURL = `https://chart.googleapis.com/chart?chs=${size}x${size}&cht=qr&chl=${encodedText}`;
                        return `<img src="${googleChartsURL}" style="width: ${size}px; height: ${size}px;">`;
                    }
                };
            };
            qrCodeLoaded = true;
            console.log('Local QR Code fallback loaded');
        }
        
        // Start loading the library
        loadQRCodeLibrary();
    </script>
    <style>
        :root {
            --primary: #1e3a8a;
            --secondary: #1e40af;
            --accent: #3b82f6;
            --background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #1e40af 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --text-muted: rgba(255, 255, 255, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            font-weight: 400;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(30, 58, 138, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(30, 64, 175, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(59, 130, 246, 0.2) 0%, transparent 50%);
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* Header */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-size: 16px;
        }

        .nav {
            display: flex;
            gap: 32px;
            list-style: none;
        }

        .nav a {
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .nav a:hover,
        .nav a.active {
            color: var(--text-primary);
        }

        /* Main Content */
        .main {
            padding: 40px 0;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 16px;
        }

        /* Glass Cards */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }

        /* QR Code Container */
        .qr-container {
            text-align: center;
            padding: 32px;
        }

        .qr-display {
            margin-bottom: 24px;
        }

        .qr-display canvas {
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* Offer Details */
        .offer-details {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
        }

        .offer-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .offer-partner {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .offer-description {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* QR Info */
        .qr-info {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-label {
            color: var(--text-primary);
            font-weight: 600;
        }

        .info-value {
            color: var(--accent);
            font-weight: 600;
        }

        .info-value.success {
            color: #10b981;
        }

        /* Actions */
        .qr-actions {
            margin-top: 32px;
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .glass-button {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            border-radius: 12px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .glass-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .glass-button.primary {
            background: var(--accent);
            border-color: var(--accent);
        }

        .glass-button.primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }

        /* Footer */
        .footer {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            padding: 48px 0;
            text-align: center;
            margin-top: 80px;
        }

        .footer-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }

            .page-title {
                font-size: 28px;
            }

            .qr-container {
                padding: 24px 16px;
                /* Mobile: More opaque background for better visibility */
                background: rgba(30, 64, 175, 0.8) !important;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.3);
            }

            .glass-card {
                padding: 20px;
                /* Mobile: More opaque background for better visibility */
                background: rgba(30, 58, 138, 0.85) !important;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.3);
            }

            .qr-actions {
                flex-direction: column;
                align-items: center;
            }

            .glass-button {
                width: 100%;
                max-width: 300px;
                /* Mobile: More opaque button background */
                background: rgba(59, 130, 246, 0.9) !important;
                border: 1px solid rgba(255, 255, 255, 0.4);
            }

            .glass-button:hover {
                background: rgba(59, 130, 246, 1) !important;
            }

            /* Mobile: Stronger background gradient */
            body::before {
                background: 
                    radial-gradient(circle at 20% 80%, rgba(30, 58, 138, 0.7) 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, rgba(30, 64, 175, 0.7) 0%, transparent 50%),
                    radial-gradient(circle at 40% 40%, rgba(59, 130, 246, 0.5) 0%, transparent 50%);
            }

            /* Mobile: Header with stronger background */
            .header {
                background: rgba(30, 58, 138, 0.9) !important;
                backdrop-filter: blur(15px);
                border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            }

            /* Mobile: Footer with stronger background */
            .footer {
                background: rgba(30, 58, 138, 0.9) !important;
                backdrop-filter: blur(15px);
                border-top: 1px solid rgba(255, 255, 255, 0.3);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">⛵</div>
                    BAYK Partnership
                </div>
                <nav>
                    <ul class="nav">
                        <li><a href="index.html">Dashboard</a></li>
                        <li><a href="offers.html">Browse Offers</a></li>
                        <li><a href="savings.html">My Savings</a></li>
                        <li><a href="#" onclick="logout()">Logout</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- QR Code Section -->
            <div class="glass-card">
                <h1 class="page-title">Your QR Code</h1>
                <p class="page-subtitle">Show this QR code to the partner to redeem your discount</p>
                
                <div class="qr-container">
                    <div id="qr-code-display" class="qr-display">
                        <!-- QR Code will be generated here -->
                    </div>
                    
                    <div class="offer-details">
                        <h3 class="offer-title" id="offer-title">Loading offer details...</h3>
                        <p class="offer-partner" id="offer-partner">Partner: Loading...</p>
                        <p class="offer-description" id="offer-description">Description: Loading...</p>
                    </div>
                    
                    <div class="qr-info">
                        <div class="info-row">
                            <span class="info-label">Valid for:</span>
                            <span class="info-value" id="time-remaining">5:00</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Single Use:</span>
                            <span class="info-value success">✓ Yes</span>
                        </div>
                    </div>
                    
                    <div class="qr-actions">
                        <button onclick="generateNewQR()" class="glass-button primary">Generate New QR</button>
                        <button onclick="goBack()" class="glass-button">Back to Offers</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p class="footer-text">&copy; 2025 BAYK Partnership Platform. All rights reserved.</p>
            <p class="footer-text" style="margin-top: 8px;">Bodrum Açıkdeniz Yelken Spor Kulübü - Connecting sailors with local businesses</p>
        </div>
    </footer>

    <script>
        // QR Code generation and management
        let currentQRData = null;
        let qrTimer = null;
        let timeRemaining = 300; // 5 minutes in seconds

        // Initialize QR code when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for QR code library to load
            waitForQRCodeLibrary().then(() => {
                generateQRCode();
                startTimer();
            }).catch(() => {
                showQRFallback(document.getElementById('qr-code-display'), 'QR Code library failed to load');
                startTimer();
            });
        });
        
        function waitForQRCodeLibrary() {
            return new Promise((resolve, reject) => {
                const maxWaitTime = 10000; // 10 seconds
                const checkInterval = 100; // Check every 100ms
                let waitTime = 0;
                
                const checkLibrary = () => {
                    if (qrCodeLoaded && typeof qrcode !== 'undefined') {
                        resolve();
                    } else if (waitTime >= maxWaitTime) {
                        reject(new Error('QR Code library loading timeout'));
                    } else {
                        waitTime += checkInterval;
                        setTimeout(checkLibrary, checkInterval);
                    }
                };
                
                checkLibrary();
            });
        }

        function generateQRCode() {
            // Get offer details from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const offerId = urlParams.get('offerId') || 'demo-offer';
            const memberId = 'm001'; // Zafer Gunel's ID
            
            console.log('Generating QR code for offer ID:', offerId);
            
            // Create QR data with timestamp for uniqueness
            const timestamp = Date.now();
            const qrData = {
                memberId: memberId,
                offerId: offerId,
                timestamp: timestamp,
                token: generateToken()
            };
            
            currentQRData = qrData;
            
            // Store QR data in localStorage for partner validation
            localStorage.setItem('activeQR_' + qrData.token, JSON.stringify({
                ...qrData,
                expires: timestamp + 300000, // 5 minutes from now
                used: false
            }));
            
            // Generate QR code
            const qrString = JSON.stringify(qrData);
            createQRCode(qrString);
            
            // Load offer details
            loadOfferDetails(offerId);
        }

        function createQRCode(text) {
            const qrDisplay = document.getElementById('qr-code-display');
            
            // Clear previous QR code
            qrDisplay.innerHTML = '';
            
            // Check if qrcode library is available
            if (typeof qrcode === 'undefined') {
                console.error('qrcode library not available');
                showQRFallback(qrDisplay, text);
                return;
            }
            
            try {
                // Generate QR code using QR-Code-Generator
                const qr = qrcode(0, 'M'); // Type 0 = auto, Error correction level M
                qr.addData(text);
                qr.make();
                
                // Create canvas for QR code
                const canvas = document.createElement('canvas');
                const cellSize = 4; // Size of each cell in pixels
                const margin = 4; // Margin around QR code
                const size = qr.getModuleCount() * cellSize + margin * 2;
                
                canvas.width = size;
                canvas.height = size;
                
                const ctx = canvas.getContext('2d');
                
                // Set background
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, size, size);
                
                // Draw QR code
                ctx.fillStyle = '#1e3a8a'; // Midnight Ocean Blue
                for (let row = 0; row < qr.getModuleCount(); row++) {
                    for (let col = 0; col < qr.getModuleCount(); col++) {
                        if (qr.isDark(row, col)) {
                            ctx.fillRect(
                                col * cellSize + margin,
                                row * cellSize + margin,
                                cellSize,
                                cellSize
                            );
                        }
                    }
                }
                
                qrDisplay.appendChild(canvas);
                console.log('QR Code generated successfully');
                
            } catch (error) {
                console.error('QR Code generation failed:', error);
                showQRFallback(qrDisplay, text);
            }
        }

        function showQRFallback(container, qrString) {
            // Try Google Charts API as visual fallback first
            tryGoogleChartsFallback(container, qrString).catch(() => {
                // If Google Charts also fails, show text fallback
                container.innerHTML = `
                    <div class="glass-card">
                        <h3 style="color: var(--text-primary); margin-bottom: 1rem;">QR Code (Text Format)</h3>
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 8px; font-family: monospace; word-break: break-all; color: var(--text-primary);">
                            ${qrString}
                        </div>
                        <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 1rem;">
                            Show this text to the partner for manual validation
                        </p>
                    </div>
                `;
            });
        }
        
        function tryGoogleChartsFallback(container, qrString) {
            return new Promise((resolve, reject) => {
                // Encode the QR string for URL
                const encodedString = encodeURIComponent(qrString);
                const googleChartsURL = `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodedString}`;
                
                // Create image element
                const img = document.createElement('img');
                img.src = googleChartsURL;
                img.style.borderRadius = '8px';
                img.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                
                img.onload = function() {
                    container.innerHTML = `
                        <div class="glass-card">
                            <h3 style="color: var(--text-primary); margin-bottom: 1rem;">QR Code (Google Charts)</h3>
                            <div style="text-align: center;">
                                ${img.outerHTML}
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 1rem;">
                                Generated using Google Charts API
                            </p>
                        </div>
                    `;
                    resolve();
                };
                
                img.onerror = function() {
                    reject(new Error('Google Charts API failed'));
                };
                
                // Set timeout for Google Charts request
                setTimeout(() => {
                    reject(new Error('Google Charts API timeout'));
                }, 5000);
            });
        }

        async function loadOfferDetails(offerId) {
            try {
                console.log('Loading offer details for ID:', offerId);
                
                // Load offers and partners data with cache busting
                const [offersResponse, partnersResponse] = await Promise.all([
                    fetch('../assets/data/offers.json?v=' + Date.now()),
                    fetch('../assets/data/users.json?v=' + Date.now())
                ]);
                
                const offersData = await offersResponse.json();
                const usersData = await partnersResponse.json();
                
                console.log('Loaded offers data:', offersData.offers.length, 'offers');
                console.log('Loaded partners data:', usersData.partners.length, 'partners');
                
                // Find the specific offer
                const offer = offersData.offers.find(o => o.id === offerId);
                if (!offer) {
                    console.error('Offer not found:', offerId);
                    console.log('Available offer IDs:', offersData.offers.map(o => o.id));
                    return;
                }
                
                console.log('Found offer:', offer);
                
                // Find the partner
                const partner = usersData.partners.find(p => p.id === offer.partner_id);
                const partnerName = partner ? partner.business_name : 'Unknown Partner';
                
                console.log('Found partner:', partner);
                console.log('Partner name:', partnerName);
                
                // Update the UI with the correct offer details
                document.getElementById('offer-title').textContent = offer.title;
                document.getElementById('offer-partner').textContent = `Partner: ${partnerName}`;
                document.getElementById('offer-description').textContent = `Description: ${offer.description}`;
                
            } catch (error) {
                console.error('Error loading offer details:', error);
                // Fallback to hardcoded data for known offers
                const fallbackOffers = {
                    'o003': {
                        title: '$10 off dinner for two at Fifi',
                        partner: 'Fifi',
                        description: 'Save $10 on dinner when dining with a companion.'
                    },
                    'o004': {
                        title: '20% off weekend stays',
                        partner: 'Seckin Konaklar',
                        description: 'Enjoy 20% off your weekend accommodation at Marina Resort.'
                    },
                    'o001': {
                        title: '15% off all meals at Sunger Pizza',
                        partner: 'Sunger Pizza',
                        description: 'Valid for lunch and dinner. Cannot be combined with other offers.'
                    }
                };
                
                const fallbackOffer = fallbackOffers[offerId];
                if (fallbackOffer) {
                    document.getElementById('offer-title').textContent = fallbackOffer.title;
                    document.getElementById('offer-partner').textContent = `Partner: ${fallbackOffer.partner}`;
                    document.getElementById('offer-description').textContent = `Description: ${fallbackOffer.description}`;
                    console.log('Using fallback data for offer:', offerId);
                } else {
                    document.getElementById('offer-title').textContent = 'Offer Details';
                    document.getElementById('offer-partner').textContent = 'Partner: Loading...';
                    document.getElementById('offer-description').textContent = 'Description: Unable to load offer details.';
                }
            }
        }

        function generateToken() {
            return Math.random().toString(36).substr(2, 9);
        }

        function startTimer() {
            timeRemaining = 300; // Reset to 5 minutes
            updateTimerDisplay();
            
            qrTimer = setInterval(function() {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(qrTimer);
                    showExpiredMessage();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('time-remaining').textContent = timeString;
        }

        function showExpiredMessage() {
            document.getElementById('time-remaining').textContent = 'Expired';
            document.getElementById('time-remaining').style.color = '#ef4444';
            
            // Disable QR code
            const qrContainer = document.getElementById('qr-code-display');
            qrContainer.style.opacity = '0.5';
            qrContainer.style.pointerEvents = 'none';
        }

        function generateNewQR() {
            // Clear existing timer
            if (qrTimer) {
                clearInterval(qrTimer);
            }
            
            // Wait for QR code library to load before generating new QR
            waitForQRCodeLibrary().then(() => {
                generateQRCode();
                startTimer();
            }).catch(() => {
                showQRFallback(document.getElementById('qr-code-display'), 'QR Code library failed to load');
                startTimer();
            });
        }

        function goBack() {
            window.location.href = 'offers.html';
        }

        function logout() {
            // Clear any active QR codes
            if (currentQRData) {
                localStorage.removeItem('activeQR_' + currentQRData.token);
            }
            
            // Redirect to main page
            window.location.href = '../index.html';
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            if (qrTimer) {
                clearInterval(qrTimer);
            }
        });
    </script>
</body>
</html>