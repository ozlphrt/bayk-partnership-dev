<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code - Sailing Club Partnership</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- QR Code Library - Robust loading with multiple fallbacks -->
    <script>
        // QR Library loading state
        window.QRCodeLoading = true;
        window.QRCodeLoaded = false;
        window.QRCodeFallback = false;
        
        // Function to check if QRCode is available
        function checkQRCodeAvailable() {
            return typeof QRCode !== 'undefined' && QRCode.toCanvas;
        }
        
        // Alternative QR generation using Google Charts API
        function generateQRWithGoogleCharts(qrData) {
            const qrCodeElement = document.getElementById('qr-code');
            const qrText = JSON.stringify(qrData);
            const qrUrl = `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodeURIComponent(qrText)}`;
            
            qrCodeElement.innerHTML = `
                <img src="${qrUrl}" alt="QR Code" style="border: 2px solid var(--primary-blue); border-radius: 0.5rem; max-width: 200px; height: auto;">
            `;
            
            console.log('QR code generated using Google Charts API');
        }
        
        // Function to load QR library with multiple fallbacks
        function loadQRLibrary() {
            console.log('Loading QR Code library...');
            
            // Try multiple CDN sources
            const cdnSources = [
                'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
                'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js',
                'https://cdn.skypack.dev/qrcode@1.5.3/build/qrcode.min.js'
            ];
            
            let currentIndex = 0;
            
            function tryNextCDN() {
                if (currentIndex >= cdnSources.length) {
                    console.log('All CDN sources failed, using fallback method');
                    window.QRCodeFallback = true;
                    window.QRCodeLoading = false;
                    return;
                }
                
                const script = document.createElement('script');
                script.src = cdnSources[currentIndex];
                script.onload = function() {
                    console.log(`QR library loaded successfully from CDN ${currentIndex + 1}`);
                    window.QRCodeLoaded = true;
                    window.QRCodeLoading = false;
                };
                script.onerror = function() {
                    console.log(`CDN ${currentIndex + 1} failed, trying next...`);
                    currentIndex++;
                    tryNextCDN();
                };
                document.head.appendChild(script);
            }
            
            tryNextCDN();
        }
        
        // Start loading QR library
        loadQRLibrary();
    </script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <a href="../index.html" class="navbar-brand">
                <span class="sailing-icon">â›µ</span>
                Sailing Club Partnership
            </a>
            <ul class="navbar-nav">
                <li><a href="index.html">Dashboard</a></li>
                <li><a href="offers.html">Browse Offers</a></li>
                <li><a href="savings.html">My Savings</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container" style="padding: 2rem 0;">
        <!-- QR Code Display -->
        <section class="qr-container">
            <h2>Your Discount QR Code</h2>
            <div id="qr-code" class="qr-code">
                <div id="loading-indicator" style="text-align: center; padding: 2rem;">
                    <div class="loading" style="margin: 0 auto 1rem;"></div>
                    <p style="color: var(--text-light);">Loading QR code generator...</p>
                </div>
            </div>
            <div id="qr-timer" class="qr-timer" style="display: none;">5:00</div>
            <p style="color: var(--text-light); margin: 1rem 0;">
                Show this code to the partner business to redeem your discount
            </p>
        </section>

        <!-- Offer Details -->
        <section class="card">
            <div class="card-header">
                <h3>Offer Details</h3>
            </div>
            <div id="offer-details">
                <!-- Offer details will be loaded here -->
            </div>
        </section>

        <!-- Instructions -->
        <section class="card">
            <div class="card-header">
                <h3>How to Use</h3>
            </div>
            <div class="instructions">
                <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                    <div style="background-color: var(--primary-blue); color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; margin-right: 1rem; font-weight: bold;">1</div>
                    <p>Show this QR code to the partner business staff</p>
                </div>
                <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                    <div style="background-color: var(--primary-blue); color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; margin-right: 1rem; font-weight: bold;">2</div>
                    <p>They will scan the code to validate your discount</p>
                </div>
                <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                    <div style="background-color: var(--primary-blue); color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; margin-right: 1rem; font-weight: bold;">3</div>
                    <p>Enjoy your savings and complete your purchase</p>
                </div>
            </div>
        </section>

        <!-- Security Notice -->
        <section class="alert alert-info">
            <strong>Security Notice:</strong> This QR code is unique and expires in 5 minutes. It cannot be reused or shared. If the code expires, simply generate a new one.
        </section>

        <!-- Actions -->
        <section class="text-center" style="margin: 2rem 0;">
            <button class="btn btn-primary" onclick="generateNewQR()" style="margin-right: 1rem;">
                Generate New Code
            </button>
            <a href="offers.html" class="btn btn-outline">
                Back to Offers
            </a>
        </section>
    </main>

    <!-- Footer -->
    <footer style="background-color: var(--primary-blue); color: var(--white); padding: 2rem 0; margin-top: 4rem;">
        <div class="container text-center">
            <p>&copy; 2025 Sailing Club Partnership Platform. All rights reserved.</p>
        </div>
    </footer>

    <script>
        let qrTimer;
        let timeLeft = 300; // 5 minutes in seconds
        let currentOffer = null;
        let currentPartner = null;

        // Logout functionality
        function logout() {
            localStorage.removeItem('selectedRole');
            window.location.href = '../index.html';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in as member
            const currentRole = localStorage.getItem('selectedRole');
            if (currentRole !== 'member') {
                window.location.href = '../index.html';
                return;
            }

            // Check if offer is selected
            const selectedOfferId = localStorage.getItem('selectedOffer');
            if (!selectedOfferId) {
                window.location.href = 'offers.html';
                return;
            }

            // Wait for QR library to load or fail
            waitForQRLibrary(selectedOfferId);
        });

        // Function to wait for QR library loading
        function waitForQRLibrary(offerId) {
            const checkInterval = setInterval(() => {
                if (!window.QRCodeLoading) {
                    clearInterval(checkInterval);
                    
                    if (window.QRCodeLoaded && checkQRCodeAvailable()) {
                        console.log('QR library loaded successfully, using QR generation');
                        loadOfferData(offerId);
                    } else {
                        console.log('QR library failed to load, using fallback method');
                        loadOfferDataWithFallback(offerId);
                    }
                }
            }, 100);
            
            // Timeout after 5 seconds
            setTimeout(() => {
                clearInterval(checkInterval);
                if (window.QRCodeLoading) {
                    console.log('QR library loading timeout, using fallback method');
                    window.QRCodeLoading = false;
                    window.QRCodeFallback = true;
                    loadOfferDataWithFallback(offerId);
                }
            }, 5000);
        }

        async function loadOfferDataWithFallback(offerId) {
            try {
                // Load offers and partners data
                const [offersResponse, partnersResponse] = await Promise.all([
                    fetch('../assets/data/offers.json'),
                    fetch('../assets/data/users.json')
                ]);

                const offersData = await offersResponse.json();
                const usersData = await partnersResponse.json();

                // Find the selected offer and partner
                currentOffer = offersData.offers.find(o => o.id === offerId);
                currentPartner = usersData.partners.find(p => p.id === currentOffer.partner_id);

                if (!currentOffer || !currentPartner) {
                    alert('Offer not found. Please try again.');
                    window.location.href = 'offers.html';
                    return;
                }

                displayOfferDetails();
                generateFallbackQR();
                startTimer();
            } catch (error) {
                console.error('Error loading offer data:', error);
                alert('Error loading offer. Please try again.');
            }
        }

        async function loadOfferData(offerId) {
            try {
                // Load offers and partners data
                const [offersResponse, partnersResponse] = await Promise.all([
                    fetch('../assets/data/offers.json'),
                    fetch('../assets/data/users.json')
                ]);

                const offersData = await offersResponse.json();
                const usersData = await partnersResponse.json();

                // Find the selected offer and partner
                currentOffer = offersData.offers.find(o => o.id === offerId);
                currentPartner = usersData.partners.find(p => p.id === currentOffer.partner_id);

                if (!currentOffer || !currentPartner) {
                    alert('Offer not found. Please try again.');
                    window.location.href = 'offers.html';
                    return;
                }

                displayOfferDetails();
                generateQRCode();
                startTimer();
            } catch (error) {
                console.error('Error loading offer data:', error);
                alert('Error loading offer. Please try again.');
            }
        }

        function displayOfferDetails() {
            const detailsContainer = document.getElementById('offer-details');
            
            // Format discount display
            let discountDisplay = '';
            if (currentOffer.discount_type === 'percentage') {
                discountDisplay = `${currentOffer.discount_value}% off`;
            } else if (currentOffer.discount_type === 'fixed') {
                discountDisplay = `$${currentOffer.discount_value} off`;
            } else if (currentOffer.discount_type === 'bogo') {
                discountDisplay = 'Buy One, Get One';
            }

            detailsContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div>
                        <h4>${currentOffer.title}</h4>
                        <p style="color: var(--text-light);">${currentPartner.business_name}</p>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--secondary-green);">${discountDisplay}</div>
                    </div>
                </div>
                <p style="margin-bottom: 1rem;">${currentOffer.description}</p>
                <div style="background-color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <strong>Terms & Conditions:</strong><br>
                    ${currentOffer.terms}
                </div>
                <div style="display: flex; justify-content: space-between; color: var(--text-light); font-size: 0.9rem;">
                    <span><strong>Valid until:</strong> ${new Date(currentOffer.valid_until).toLocaleDateString()}</span>
                    <span><strong>Business:</strong> ${currentPartner.business_name}</span>
                </div>
            `;
        }

        function generateQRCode() {
            // Generate unique QR token
            const qrToken = generateUniqueToken();
            const qrData = {
                token: qrToken,
                member_id: 'm001', // Sarah Marina's ID
                offer_id: currentOffer.id,
                timestamp: new Date().toISOString(),
                expires_at: new Date(Date.now() + 5 * 60 * 1000).toISOString() // 5 minutes from now
            };

            // Store QR data for validation
            localStorage.setItem('currentQRData', JSON.stringify(qrData));

            // Generate QR code
            const qrCodeElement = document.getElementById('qr-code');
            
            // Clear loading indicator and show timer
            qrCodeElement.innerHTML = '';
            document.getElementById('qr-timer').style.display = 'block';
            
            // Try QRCode library first
            if (checkQRCodeAvailable()) {
                // Create a canvas element for the QR code
                const canvas = document.createElement('canvas');
                qrCodeElement.appendChild(canvas);
                
                QRCode.toCanvas(canvas, JSON.stringify(qrData), {
                    width: 200,
                    height: 200,
                    color: {
                        dark: '#1e40af',
                        light: '#ffffff'
                    },
                    margin: 2
                }, function (error) {
                    if (error) {
                        console.error('QRCode library error:', error);
                        // Try Google Charts API as fallback
                        generateQRWithGoogleCharts(qrData);
                    } else {
                        console.log('QR Code generated successfully with QRCode library');
                    }
                });
            } else {
                console.log('QRCode library not available, trying Google Charts API');
                // Try Google Charts API
                generateQRWithGoogleCharts(qrData);
            }
        }

        function generateUniqueToken() {
            return 'qr_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        function generateFallbackQR() {
            // Generate unique QR token
            const qrToken = generateUniqueToken();
            const qrData = {
                token: qrToken,
                member_id: 'm001', // Sarah Marina's ID
                offer_id: currentOffer.id,
                timestamp: new Date().toISOString(),
                expires_at: new Date(Date.now() + 5 * 60 * 1000).toISOString() // 5 minutes from now
            };

            // Store QR data for validation
            localStorage.setItem('currentQRData', JSON.stringify(qrData));

            // Clear loading indicator and show timer
            const qrCodeElement = document.getElementById('qr-code');
            qrCodeElement.innerHTML = '';
            document.getElementById('qr-timer').style.display = 'block';
            
            // Try Google Charts API first, then fallback to text
            console.log('Using fallback QR generation - trying Google Charts API');
            generateQRWithGoogleCharts(qrData);
        }

        function createFallbackQR(element, qrData) {
            element.innerHTML = `
                <div style="border: 2px solid var(--primary-blue); border-radius: 0.5rem; padding: 1.5rem; background-color: white; text-align: center; max-width: 300px; margin: 0 auto;">
                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--primary-blue); margin-bottom: 1rem;">
                        â›µ DISCOUNT CODE
                    </div>
                    <div style="font-family: monospace; font-size: 0.9rem; color: var(--text-dark); margin-bottom: 1rem; word-break: break-all; background-color: #f3f4f6; padding: 0.5rem; border-radius: 0.25rem;">
                        ${qrData.token}
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 1rem;">
                        Show this code to the partner
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-light); background-color: #fef3c7; padding: 0.5rem; border-radius: 0.25rem;">
                        ðŸ’¡ Partner can enter this code manually in their scanner
                    </div>
                </div>
            `;
        }

        function startTimer() {
            qrTimer = setInterval(function() {
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft <= 0) {
                    clearInterval(qrTimer);
                    handleQRExpiry();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timerElement = document.getElementById('qr-timer');
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Change color as time runs out
            if (timeLeft <= 60) {
                timerElement.style.color = 'var(--accent-red)';
            } else if (timeLeft <= 120) {
                timerElement.style.color = '#f59e0b';
            }
        }

        function handleQRExpiry() {
            document.getElementById('qr-timer').textContent = 'EXPIRED';
            document.getElementById('qr-timer').style.color = 'var(--accent-red)';
            
            // Disable QR code
            const qrCodeElement = document.getElementById('qr-code');
            qrCodeElement.style.opacity = '0.5';
            qrCodeElement.style.filter = 'grayscale(100%)';

            // Show expiry message
            const expiryAlert = document.createElement('div');
            expiryAlert.className = 'alert alert-error';
            expiryAlert.innerHTML = '<strong>QR Code Expired:</strong> This code is no longer valid. Please generate a new one.';
            document.querySelector('.qr-container').appendChild(expiryAlert);
        }

        function generateNewQR() {
            // Clear existing timer
            if (qrTimer) {
                clearInterval(qrTimer);
            }

            // Reset timer
            timeLeft = 300;
            
            // Remove expiry alert if exists
            const existingAlert = document.querySelector('.alert-error');
            if (existingAlert) {
                existingAlert.remove();
            }

            // Reset QR code display
            const qrCodeElement = document.getElementById('qr-code');
            qrCodeElement.style.opacity = '1';
            qrCodeElement.style.filter = 'none';

            // Check if QRCode library is available or use fallback
            if (typeof QRCode === 'undefined' || window.QRCodeFallback) {
                console.log('Using fallback QR generation');
                generateFallbackQR();
            } else {
                generateQRCode();
            }
            startTimer();
        }

        // Clean up timer when page is unloaded
        window.addEventListener('beforeunload', function() {
            if (qrTimer) {
                clearInterval(qrTimer);
            }
        });
    </script>
</body>
</html>
