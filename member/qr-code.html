<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code - BAYK Partnership</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⛵</text></svg>">
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- QR Code Generation Library with fallbacks - QR-Code-Generator by Nayuki -->
    <script>
        // QR Code library loading with multiple fallbacks
        const qrCodeCDNs = [
            'https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js',
            'https://unpkg.com/qrcode-generator@1.4.4/qrcode.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js'
        ];
        
        let qrCodeLoaded = false;
        let currentCDN = 0;
        
        function loadQRCodeLibrary() {
            if (currentCDN >= qrCodeCDNs.length) {
                console.error('All QR Code CDNs failed to load, using local fallback');
                loadLocalQRCodeFallback();
                return;
            }
            
            const script = document.createElement('script');
            script.src = qrCodeCDNs[currentCDN];
            script.type = 'text/javascript'; // Ensure it's treated as regular JS, not module
            
            script.onload = function() {
                // Check if qrcode is actually available and working
                setTimeout(() => {
                    if (typeof qrcode !== 'undefined' && typeof qrcode === 'function') {
                        console.log('QR Code library loaded successfully from CDN', currentCDN + 1);
                        qrCodeLoaded = true;
                    } else {
                        console.log('CDN', currentCDN + 1, 'loaded but qrcode not available, trying next...');
                        currentCDN++;
                        loadQRCodeLibrary();
                    }
                }, 100);
            };
            
            script.onerror = function() {
                console.log('CDN', currentCDN + 1, 'failed, trying next...');
                currentCDN++;
                loadQRCodeLibrary();
            };
            
            document.head.appendChild(script);
        }
        
        function loadLocalQRCodeFallback() {
            // Create a minimal qrcode implementation using Google Charts API
            window.qrcode = function(typeNumber, errorCorrectionLevel) {
                return {
                    addData: function(data) {
                        this.data = data;
                        return this;
                    },
                    make: function() {
                        return this;
                    },
                    createImgTag: function(cellSize, margin) {
                        const size = cellSize || 200;
                        const encodedText = encodeURIComponent(this.data);
                        const googleChartsURL = `https://chart.googleapis.com/chart?chs=${size}x${size}&cht=qr&chl=${encodedText}`;
                        return `<img src="${googleChartsURL}" style="width: ${size}px; height: ${size}px;">`;
                    }
                };
            };
            qrCodeLoaded = true;
            console.log('Local QR Code fallback loaded');
        }
        
        // Start loading the library
        loadQRCodeLibrary();
    </script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <a href="../index.html" class="navbar-brand">
                <svg width="24" height="24" viewBox="0 0 100 100" class="bayk-logo-small">
                    <rect x="10" y="10" width="80" height="80" fill="none" stroke="currentColor" stroke-width="3"/>
                    <path d="M15 75 Q50 65 85 75 L85 85 L15 85 Z" fill="#0047AB"/>
                    <path d="M50 15 L50 70 L35 70 Z" fill="#FF8C00"/>
                    <path d="M35 70 Q50 75 65 70 L65 75 L35 75 Z" fill="currentColor"/>
                </svg>
                BAYK Partnership
            </a>
            <ul class="navbar-nav">
                <li><a href="index.html">Dashboard</a></li>
                <li><a href="offers.html">Browse Offers</a></li>
                <li><a href="savings.html">My Savings</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container" style="padding: 2rem 0;">
        <!-- QR Code Section -->
        <section class="card">
            <div class="card-header">
                <h1 style="color: var(--text-dark);">Your QR Code</h1>
                <p style="color: var(--text-light); font-size: 1.1rem;">
                    Show this QR code to the partner to redeem your discount
                </p>
            </div>
            
            <div class="qr-container" style="text-align: center; padding: 2rem;">
                <div id="qr-code-display" style="margin-bottom: 1.5rem;">
                    <!-- QR Code will be generated here -->
                </div>
                
                <div class="offer-details" style="background: var(--background-light); border-radius: 16px; padding: 20px; margin: 1rem 0; box-shadow: 12px 12px 30px var(--shadow-dark), -12px -12px 30px var(--shadow-light);">
                    <h3 style="color: var(--text-dark); margin-bottom: 0.5rem;" id="offer-title">Loading offer details...</h3>
                    <p style="color: var(--text-light); margin-bottom: 0.5rem;" id="offer-partner">Partner: Loading...</p>
                    <p style="color: var(--text-light); font-size: 0.9rem;" id="offer-description">Description: Loading...</p>
                </div>
                
                <div class="qr-info" style="background: var(--background-light); border-radius: 16px; padding: 20px; margin: 1rem 0; box-shadow: 12px 12px 30px var(--shadow-dark), -12px -12px 30px var(--shadow-light);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span style="color: var(--text-dark); font-weight: 600;">Valid for:</span>
                        <span style="color: var(--primary-blue); font-weight: 600;" id="time-remaining">5:00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-dark); font-weight: 600;">Single Use:</span>
                        <span style="color: var(--secondary-green); font-weight: 600;">✓ Yes</span>
                    </div>
                </div>
                
                <div class="qr-actions" style="margin-top: 2rem;">
                    <button onclick="generateNewQR()" class="btn btn-primary" style="margin-right: 1rem;">Generate New QR</button>
                    <button onclick="goBack()" class="btn btn-outline">Back to Offers</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer style="background: var(--background-light); color: var(--text-light); text-align: center; padding: 2rem 0; margin-top: 3rem; box-shadow: 0 -4px 20px var(--shadow-dark);">
        <div class="container">
            <p>&copy; 2025 BAYK Partnership Platform. All rights reserved.</p>
            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Bodrum Açıkdeniz Yelken Spor Kulübü - Connecting sailors with local businesses</p>
        </div>
    </footer>

    <script>
        // QR Code generation and management
        let currentQRData = null;
        let qrTimer = null;
        let timeRemaining = 300; // 5 minutes in seconds

        // Initialize QR code when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for QR code library to load
            waitForQRCodeLibrary().then(() => {
                generateQRCode();
                startTimer();
            }).catch(() => {
                showQRFallback(document.getElementById('qr-code-display'), 'QR Code library failed to load');
                startTimer();
            });
        });
        
        function waitForQRCodeLibrary() {
            return new Promise((resolve, reject) => {
                const maxWaitTime = 10000; // 10 seconds
                const checkInterval = 100; // Check every 100ms
                let waitTime = 0;
                
                const checkLibrary = () => {
                    if (qrCodeLoaded && typeof qrcode !== 'undefined') {
                        resolve();
                    } else if (waitTime >= maxWaitTime) {
                        reject(new Error('QR Code library loading timeout'));
                    } else {
                        waitTime += checkInterval;
                        setTimeout(checkLibrary, checkInterval);
                    }
                };
                
                checkLibrary();
            });
        }

        function generateQRCode() {
            // Get offer details from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const offerId = urlParams.get('offerId') || 'demo-offer';
            const memberId = 'm001'; // Zafer Gunel's ID
            
            // Create QR data with timestamp for uniqueness
            const timestamp = Date.now();
            const qrData = {
                memberId: memberId,
                offerId: offerId,
                timestamp: timestamp,
                token: generateToken()
            };
            
            currentQRData = qrData;
            
            // Store QR data in localStorage for partner validation
            localStorage.setItem('activeQR_' + qrData.token, JSON.stringify({
                ...qrData,
                expires: timestamp + 300000, // 5 minutes from now
                used: false
            }));
            
            // Generate QR code
            const qrString = JSON.stringify(qrData);
            createQRCode(qrString);
            
            // Load offer details
            loadOfferDetails(offerId);
        }

        function createQRCode(text) {
            const qrDisplay = document.getElementById('qr-code-display');
            
            // Clear previous QR code
            qrDisplay.innerHTML = '';
            
            // Check if qrcode library is available
            if (typeof qrcode === 'undefined') {
                console.error('qrcode library not available');
                showQRFallback(qrDisplay, text);
                return;
            }
            
            try {
                // Generate QR code using QR-Code-Generator
                const qr = qrcode(0, 'M'); // Type 0 = auto, Error correction level M
                qr.addData(text);
                qr.make();
                
                // Create canvas for QR code
                const canvas = document.createElement('canvas');
                const cellSize = 4; // Size of each cell in pixels
                const margin = 4; // Margin around QR code
                const size = qr.getModuleCount() * cellSize + margin * 2;
                
                canvas.width = size;
                canvas.height = size;
                
                const ctx = canvas.getContext('2d');
                
                // Set background
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, size, size);
                
                // Draw QR code
                ctx.fillStyle = '#0047AB'; // BAYK Blue
                for (let row = 0; row < qr.getModuleCount(); row++) {
                    for (let col = 0; col < qr.getModuleCount(); col++) {
                        if (qr.isDark(row, col)) {
                            ctx.fillRect(
                                col * cellSize + margin,
                                row * cellSize + margin,
                                cellSize,
                                cellSize
                            );
                        }
                    }
                }
                
                qrDisplay.appendChild(canvas);
                console.log('QR Code generated successfully');
                
            } catch (error) {
                console.error('QR Code generation failed:', error);
                showQRFallback(qrDisplay, text);
            }
        }

        function showQRFallback(container, qrString) {
            // Try Google Charts API as visual fallback first
            tryGoogleChartsFallback(container, qrString).catch(() => {
                // If Google Charts also fails, show text fallback
                container.innerHTML = `
                    <div style="background: var(--background-light); border-radius: 16px; padding: 20px; box-shadow: 12px 12px 30px var(--shadow-dark), -12px -12px 30px var(--shadow-light);">
                        <h3 style="color: var(--text-dark); margin-bottom: 1rem;">QR Code (Text Format)</h3>
                        <div style="background: white; padding: 1rem; border-radius: 8px; font-family: monospace; word-break: break-all; color: var(--text-dark);">
                            ${qrString}
                        </div>
                        <p style="color: var(--text-light); font-size: 0.9rem; margin-top: 1rem;">
                            Show this text to the partner for manual validation
                        </p>
                    </div>
                `;
            });
        }
        
        function tryGoogleChartsFallback(container, qrString) {
            return new Promise((resolve, reject) => {
                // Encode the QR string for URL
                const encodedString = encodeURIComponent(qrString);
                const googleChartsURL = `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodedString}`;
                
                // Create image element
                const img = document.createElement('img');
                img.src = googleChartsURL;
                img.style.borderRadius = '8px';
                img.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                
                img.onload = function() {
                    container.innerHTML = `
                        <div style="background: var(--background-light); border-radius: 16px; padding: 20px; box-shadow: 12px 12px 30px var(--shadow-dark), -12px -12px 30px var(--shadow-light);">
                            <h3 style="color: var(--text-dark); margin-bottom: 1rem;">QR Code (Google Charts)</h3>
                            <div style="text-align: center;">
                                ${img.outerHTML}
                            </div>
                            <p style="color: var(--text-light); font-size: 0.9rem; margin-top: 1rem;">
                                Generated using Google Charts API
                            </p>
                        </div>
                    `;
                    resolve();
                };
                
                img.onerror = function() {
                    reject(new Error('Google Charts API failed'));
                };
                
                // Set timeout for Google Charts request
                setTimeout(() => {
                    reject(new Error('Google Charts API timeout'));
                }, 5000);
            });
        }

        function loadOfferDetails(offerId) {
            // Simulate loading offer details
            const offers = {
                'demo-offer': {
                    title: '15% off all meals',
                    partner: 'Sunger Pizza',
                    description: 'Valid for lunch and dinner. Cannot be combined with other offers.'
                },
                'hotel-offer': {
                    title: '20% off weekend stays',
                    partner: 'Seckin Konaklar',
                    description: 'Enjoy 20% off your weekend accommodation.'
                },
                'marina-offer': {
                    title: '10% off boat repairs',
                    partner: 'Bodrum Milta Marina',
                    description: 'Save 10% on all marine repair services and maintenance.'
                }
            };
            
            const offer = offers[offerId] || offers['demo-offer'];
            
            document.getElementById('offer-title').textContent = offer.title;
            document.getElementById('offer-partner').textContent = `Partner: ${offer.partner}`;
            document.getElementById('offer-description').textContent = `Description: ${offer.description}`;
        }

        function generateToken() {
            return Math.random().toString(36).substr(2, 9);
        }

        function startTimer() {
            timeRemaining = 300; // Reset to 5 minutes
            updateTimerDisplay();
            
            qrTimer = setInterval(function() {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(qrTimer);
                    showExpiredMessage();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('time-remaining').textContent = timeString;
        }

        function showExpiredMessage() {
            document.getElementById('time-remaining').textContent = 'Expired';
            document.getElementById('time-remaining').style.color = 'var(--accent-red)';
            
            // Disable QR code
            const qrContainer = document.getElementById('qr-code-display');
            qrContainer.style.opacity = '0.5';
            qrContainer.style.pointerEvents = 'none';
        }

        function generateNewQR() {
            // Clear existing timer
            if (qrTimer) {
                clearInterval(qrTimer);
            }
            
            // Wait for QR code library to load before generating new QR
            waitForQRCodeLibrary().then(() => {
                generateQRCode();
                startTimer();
            }).catch(() => {
                showQRFallback(document.getElementById('qr-code-display'), 'QR Code library failed to load');
                startTimer();
            });
        }

        function goBack() {
            window.location.href = 'offers.html';
        }

        function logout() {
            // Clear any active QR codes
            if (currentQRData) {
                localStorage.removeItem('activeQR_' + currentQRData.token);
            }
            
            // Redirect to main page
            window.location.href = '../index.html';
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            if (qrTimer) {
                clearInterval(qrTimer);
            }
        });
    </script>
</body>
</html>